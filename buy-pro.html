<script>
const USDT="0x55d398326f99059fF775485246999027B3197955";
const GDSX="0xFa9d637329C79bCa321e2Bf0179ae78Bcb3d235a";
const CHAIN_ID=56; // BNB Chain

let provider, signer, account;
const $=id=>document.getElementById(id);
function toast(m){const t=$("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3500);}

async function ensureBSC(){
  const hexId="0x38"; // 56
  try{
    const cur = await window.ethereum.request({method:"eth_chainId"});
    if(cur.toLowerCase()!==hexId){
      await window.ethereum.request({
        method:"wallet_switchEthereumChain",
        params:[{chainId:hexId}]
      });
    }
  }catch(e){
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ BSC ‡πÉ‡∏ô‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ï ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ
    if(e.code===4902){
      await window.ethereum.request({
        method:"wallet_addEthereumChain",
        params:[{
          chainId: hexId,
          chainName: "BNB Smart Chain",
          nativeCurrency:{name:"BNB", symbol:"BNB", decimals:18},
          rpcUrls:["https://bsc-dataseed.binance.org"],
          blockExplorerUrls:["https://bscscan.com"]
        }]
      });
    }else{
      throw e;
    }
  }
}

async function connectWallet(){
  if(!window.ethereum){$("walletInfo").textContent="‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ MetaMask";return;}
  await ensureBSC();
  provider=new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer=provider.getSigner();
  account=await signer.getAddress();
  $("walletInfo").textContent="ü¶ä "+account.slice(0,6)+"..."+account.slice(-4);
  updateBalances();
}

async function updateBalances(){
  try{
    const [usdtBal,gdsxBal,bnbBal]=await Promise.all([
      new ethers.Contract(USDT,["function balanceOf(address) view returns(uint256)"],signer).balanceOf(account),
      new ethers.Contract(GDSX,["function balanceOf(address) view returns(uint256)"],signer).balanceOf(account),
      provider.getBalance(account)
    ]);
    const usdt=ethers.utils.formatUnits(usdtBal,18);
    const gdsx=ethers.utils.formatUnits(gdsxBal,18);
    const bnb=ethers.utils.formatEther(bnbBal);
    $("balances").textContent=`USDT ‚Äì ${parseFloat(usdt).toFixed(2)} | GDSX ‚Äì ${parseFloat(gdsx).toFixed(2)} | BNB ‚Äì ${parseFloat(bnb).toFixed(4)}`;
  }catch(e){console.log(e);}
}

// ------- 1inch helpers -------
async function getSpender(){
  const url=`https://api.1inch.io/v5.0/${CHAIN_ID}/approve/spender`;
  const r=await fetch(url); const j=await r.json();
  if(!j.address) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö 1inch spender");
  return j.address;
}
async function getAllowance(owner, token){
  const url=`https://api.1inch.io/v5.0/${CHAIN_ID}/approve/allowance?tokenAddress=${token}&walletAddress=${owner}`;
  const r=await fetch(url); const j=await r.json();
  return ethers.BigNumber.from(j.allowance||"0");
}
async function buildApproveTx(token, amount){
  const url=`https://api.1inch.io/v5.0/${CHAIN_ID}/approve/transaction?tokenAddress=${token}&amount=${amount}`;
  const r=await fetch(url); const j=await r.json();
  if(!j.to||!j.data) throw new Error("‡∏™‡∏£‡πâ‡∏≤‡∏á approve tx ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  return j;
}

async function buyGDSX(){
  try{
    if(!signer) await connectWallet();
    const amt=$("usdtAmount").value;
    if(!amt||amt<=0) return toast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô USDT");

    const amount=ethers.utils.parseUnits(amt,18).toString();
    toast("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ / spender / allowance...");

    // 1) spender + allowance
    const spender=await getSpender();
    const allowance=await getAllowance(account, USDT);
    const need=ethers.BigNumber.from(amount);

    // 2) approve ‡∏ñ‡πâ‡∏≤ allowance ‡πÑ‡∏°‡πà‡∏û‡∏≠
    if(allowance.lt(need)){
      toast("üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á Approve USDT...");
      const appr=await buildApproveTx(USDT, amount); // ‡∏à‡∏∞ approve ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
      // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô metamask
      await window.ethereum.request({method:'eth_sendTransaction',params:[{
        from: account,
        to: appr.to,
        data: appr.data,
        value: appr.value || '0x0'
      }]});
      toast("‚úÖ Approve ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
      // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏ô‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô swap (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ index/state)
      await new Promise(r=>setTimeout(r, 6000));
    }

    // 3) ‡∏™‡∏£‡πâ‡∏≤‡∏á swap tx
    toast("‚è≥ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Swap...");
    const url=`https://api.1inch.io/v5.0/${CHAIN_ID}/swap?fromTokenAddress=${USDT}&toTokenAddress=${GDSX}&amount=${amount}&fromAddress=${account}&slippage=1`;
    const res=await fetch(url); const data=await res.json();

    if(!data.tx){
      console.log("1inch swap response:", data);
      if(data.description) toast("‚ùå "+data.description);
      else toast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á Swap (LP ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏û‡∏≠)");
      return;
    }

    // 4) ‡∏™‡πà‡∏á swap tx
    toast("üí∞ ‡πÄ‡∏õ‡∏¥‡∏î MetaMask ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Swap...");
    const txHash=await window.ethereum.request({method:'eth_sendTransaction',params:[data.tx]});
    toast(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Tx: ${txHash.slice(0,10)}...`);
    updateBalances();
  }catch(e){
    console.error(e);
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
    if(e?.message?.includes("user rejected")) toast("‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°");
    else if(e?.code===4001) toast("‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô MetaMask");
    else toast("‚ùå Swap ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||"unknown"));
  }
}

// auto connect + auto refresh
window.addEventListener("load",()=>{
  if(window.ethereum) {
    connectWallet();
    setInterval(()=>{ if(account) updateBalances(); }, 30000);
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà
    window.ethereum.on?.('accountsChanged', ()=>connectWallet());
    window.ethereum.on?.('chainChanged', ()=>location.reload());
  } else {
    $("walletInfo").textContent="‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ MetaMask";
  }
});
</script>
